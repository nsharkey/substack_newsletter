season,
week,
team) %>%
summarise(
completions = sum(completions, na.rm = TRUE),
attempts = sum(attempts, na.rm = TRUE),
passing_yards = sum(passing_yards, na.rm = TRUE),
passing_tds = sum(passing_tds, na.rm = TRUE),
interceptions = sum(interceptions, na.rm = TRUE),
sacks = sum(sacks, na.rm = TRUE),
sack_yards = sum(sack_yards, na.rm = TRUE),
sack_fumbles = sum(sack_fumbles, na.rm = TRUE),
sack_fumbles_lost = sum(sack_fumbles_lost, na.rm = TRUE),
passing_air_yards = sum(passing_air_yards, na.rm = TRUE),
passing_yards_after_catch = sum(passing_yards_after_catch, na.rm = TRUE),
passing_first_downs = sum(passing_first_downs, na.rm = TRUE),
passing_epa = sum(passing_epa, na.rm = TRUE),
passing_2pt_conversions = sum(passing_2pt_conversions, na.rm = TRUE)) %>%
ungroup()
team_summary_rushing <-
player_stats %>%
group_by(
season,
week,
team) %>%
summarise(
carries = sum(carries, na.rm = TRUE),
rushing_yards = sum(rushing_yards, na.rm = TRUE),
rushing_tds = sum(rushing_tds, na.rm = TRUE),
rushing_fumbles = sum(rushing_fumbles, na.rm = TRUE),
rushing_fumbles_lost = sum(rushing_fumbles_lost, na.rm = TRUE),
rushing_first_downs = sum(rushing_first_downs, na.rm = TRUE),
rushing_epa = sum(rushing_epa, na.rm = TRUE),
rushing_2pt_conversions = sum(rushing_2pt_conversions, na.rm = TRUE)) %>%
ungroup()
team_summary_receiving <-
player_stats %>%
group_by(
season,
week,
team) %>%
summarise(
receptions = sum(receptions, na.rm = TRUE),
targets = sum(targets, na.rm = TRUE),
receiving_yards = sum(receiving_yards, na.rm = TRUE),
receiving_tds = sum(receiving_tds, na.rm = TRUE),
receiving_fumbles = sum(receiving_fumbles, na.rm = TRUE),
receiving_fumbles_lost = sum(receiving_fumbles_lost, na.rm = TRUE),
receiving_air_yards = sum(receiving_air_yards, na.rm = TRUE),
receiving_yards_after_catch = sum(receiving_yards_after_catch, na.rm = TRUE),
receiving_first_downs = sum(receiving_first_downs, na.rm = TRUE),
receiving_epa = sum(receiving_epa, na.rm = TRUE),
receiving_2pt_conversions = sum(receiving_2pt_conversions, na.rm = TRUE)) %>%
ungroup()
team_summary <-
player_stats %>%
distinct(
season,
week,
team) %>%
inner_join(team_summary_passing) %>%
inner_join(team_summary_rushing) %>%
inner_join(team_summary_receiving) %>%
mutate(
team_plays = attempts + carries,
team_rush_pct = round(attempts / team_plays, 5)) %>%
select(
season,
week,
team,
team_plays,
team_rush_pct,
passing_attempts = attempts,
rushing_attempts = carries,
receiving_targets = targets,
receiving_receptions = receptions)
rm(list = c('team_summary_passing', 'team_summary_rushing', 'team_summary_receiving'))
player_stats <-
player_stats %>%
inner_join(
y = team_summary,
by = c('season', 'week', 'team')) %>%
mutate(
passing_share = round(attempts / passing_attempts, 5),
receiving_target_share = round(targets / receiving_targets, 5),
rushing_share = round(carries / rushing_attempts, 5),
passing_yards_after_catch_pct = if_else(
passing_yards_after_catch == 0, NA_real_,
round(passing_yards_after_catch / passing_yards, 5))) %>%
mutate(
passing_epa = replace_na(passing_epa, 0),
rushing_epa = replace_na(rushing_epa, 0)) %>%
select(
-sack_yards,
-pacr,
-dakota,
-racr,
-wopr,
-fantasy_points,
-fantasy_points_ppr) %>%
mutate(
passing_completion_pct = if_else(
is.na(attempts) == TRUE, NA_real_,
round(completions / attempts, 5))) %>%
select(
season_type,
season,
week,
player_id,
player_name,
position,
team,
passing_share,
passing_completions = completions,
passing_attempts = attempts,
passing_completion_pct,
passing_yards,
passing_yards300,
passing_tds,
passing_interceptions = interceptions,
passing_sacks = sacks,
passing_sack_fumbles = sack_fumbles,
passing_sack_fumbles_lost = sack_fumbles_lost,
passing_air_yards,
passing_yards_after_catch,
passing_yards_after_catch_pct,
passing_first_downs,
passing_epa,
passing_2pt_conversions,
rushing_share,
rushing_attempts = carries,
rushing_yards,
rushing_yards100,
rushing_tds,
rushing_fumbles,
rushing_fumbles_lost,
rushing_first_downs,
rushing_epa,
rushing_2pt_conversions,
receiving_target_share,
receiving_air_yards_share = air_yards_share,
receiving_receptions = receptions,
receiving_target = targets,
receiving_yards,
receiving_yards100,
receiving_tds,
receiving_fumbles,
receiving_fumbles_lost,
receiving_air_yards,
receiving_yards_after_catch,
receiving_first_downs,
receiving_2pt_conversions
) %>%
distinct()
rm(team_summary)
# Positional stats and fantasy points by week
qbs_by_week <-
player_stats %>%
filter(position == 'QB') %>%
mutate(
season_type = as_factor(season_type),
player_id = as_factor(player_id),
player_name = as_factor(player_name),
position = as_factor(position),
team = as_factor(team)) %>%
fantasy_qb_points() %>%
group_by(
season_type,
season,
week,
position) %>%
mutate(
fantasy_points_dk_rank = min_rank(-fantasy_points_dk),
fantasy_points_espn_rank = min_rank(-fantasy_points_espn)) %>%
ungroup() %>%
select(
season_type,
season,
week,
player_id,
player_name,
position,
team,
fantasy_points_dk,
fantasy_points_espn,
fantasy_points_dk_rank,
fantasy_points_espn_rank,
starts_with('passing_'),
starts_with('rushing_'))
rbs_by_week <-
player_stats %>%
filter(position %in% c('RB', 'FB')) %>%
mutate(
season_type = as_factor(season_type),
player_id = as_factor(player_id),
player_name = as_factor(player_name),
position = as_factor(position),
team = as_factor(team)) %>%
fantasy_rb_te_wr_points() %>%
group_by(
season_type,
season,
week,
position) %>%
mutate(
fantasy_points_dk_rank = min_rank(-fantasy_points_dk),
fantasy_points_espn_rank = min_rank(-fantasy_points_espn)) %>%
ungroup() %>%
select(
season_type,
season,
week,
player_id,
player_name,
position,
team,
fantasy_points_dk,
fantasy_points_espn,
fantasy_points_dk_rank,
fantasy_points_espn_rank,
starts_with('rushing_'),
starts_with('receiving_'))
wrs_by_week <-
player_stats %>%
filter(position == 'WR') %>%
mutate(
season_type = as_factor(season_type),
player_id = as_factor(player_id),
player_name = as_factor(player_name),
position = as_factor(position),
team = as_factor(team)) %>%
fantasy_rb_te_wr_points() %>%
group_by(
season_type,
season,
week,
position) %>%
mutate(
fantasy_points_dk_rank = min_rank(-fantasy_points_dk),
fantasy_points_espn_rank = min_rank(-fantasy_points_espn)) %>%
ungroup() %>%
select(
season_type,
season,
week,
player_id,
player_name,
position,
team,
fantasy_points_dk,
fantasy_points_espn,
fantasy_points_dk_rank,
fantasy_points_espn_rank,
starts_with('receiving_'),
starts_with('rushing_'))
tes_by_week <-
player_stats %>%
filter(position == 'TE') %>%
mutate(
season_type = as_factor(season_type),
player_id = as_factor(player_id),
player_name = as_factor(player_name),
position = as_factor(position),
team = as_factor(team)) %>%
fantasy_rb_te_wr_points() %>%
group_by(
season_type,
season,
week,
position) %>%
mutate(
fantasy_points_dk_rank = min_rank(-fantasy_points_dk),
fantasy_points_espn_rank = min_rank(-fantasy_points_espn)) %>%
ungroup() %>%
select(
season_type,
season,
week,
player_id,
player_name,
position,
team,
fantasy_points_dk,
fantasy_points_espn,
fantasy_points_dk_rank,
fantasy_points_espn_rank,
starts_with('receiving_'),
starts_with('rushing_'))
write_parquet(qbs_by_week, 'posts/000_a_data_science_journey/results/qbs_by_week.parquet')
write_parquet(rbs_by_week, 'posts/000_a_data_science_journey/results/rbs_by_week.parquet')
write_parquet(wrs_by_week, 'posts/000_a_data_science_journey/results/wrs_by_week.parquet')
write_parquet(tes_by_week, 'posts/000_a_data_science_journey/results/tes_by_week.parquet')
# Positional stats and fantasy points by season
qbs_by_season <-
qbs_by_week %>%
# filter(player_name == 'M.Stafford') %>%
group_by(
season_type,
season,
player_id,
player_name,
position,
team) %>%
summarise(
games = sum(n()),
fantasy_points_dk = sum(fantasy_points_dk, na.rm = TRUE),
fantasy_points_espn = sum(fantasy_points_espn, na.rm = TRUE),
fantasy_points_dk_rank_avg = mean(fantasy_points_dk_rank, na.rm = TRUE),
fantasy_points_espn_rank_avg = mean(fantasy_points_espn_rank, na.rm = TRUE),
passing_share = mean(passing_share, na.rm = TRUE),
passing_completions = sum(passing_completions, na.rm = TRUE),
passing_attempts = sum(passing_attempts, na.rm = TRUE),
passing_completion_pct = if_else(passing_attempts <= 0, 0, round(passing_completions / passing_attempts, 5)),
passing_yards = sum(passing_yards, na.rm = TRUE),
passing_yards300 = sum(passing_yards300, na.rm = TRUE),
passing_tds = sum(passing_tds, na.rm = TRUE),
passing_interceptions = sum(passing_interceptions, na.rm = TRUE),
passing_sacks = sum(passing_sacks, na.rm = TRUE),
passing_sack_fumbles = sum(passing_sack_fumbles, na.rm = TRUE),
passing_sack_fumbles_lost = sum(passing_sack_fumbles_lost, na.rm = TRUE),
passing_air_yards = sum(passing_air_yards, na.rm = TRUE),
passing_yards_after_catch = sum(passing_yards_after_catch, na.rm = TRUE),
passing_yards_after_catch_pct = if_else(passing_yards <= 0, 0, round(passing_yards_after_catch / passing_yards, 5)),
passing_first_downs = sum(passing_first_downs, na.rm = TRUE),
passing_epa = sum(passing_epa, na.rm = TRUE),
passing_2pt_conversions = sum(passing_2pt_conversions, na.rm = TRUE),
rushing_share = mean(rushing_share, na.rm = TRUE),
rushing_attempts = sum(rushing_attempts, na.rm = TRUE),
rushing_yards = sum(rushing_yards, na.rm = TRUE),
rushing_yards100 = sum(rushing_yards100, na.rm = TRUE),
rushing_tds = sum(rushing_tds, na.rm = TRUE),
rushing_fumbles = sum(rushing_fumbles, na.rm = TRUE),
rushing_fumbles_lost = sum(rushing_fumbles_lost, na.rm = TRUE),
rushing_first_downs = sum(rushing_first_downs, na.rm = TRUE),
rushing_epa = sum(rushing_epa, na.rm = TRUE),
rushing_2pt_conversions = sum(rushing_2pt_conversions, na.rm = TRUE)) %>%
ungroup() %>%
group_by(
season_type,
season,
position) %>%
mutate(
fantasy_points_dk_rank = min_rank(-fantasy_points_dk),
fantasy_points_espn_rank = min_rank(-fantasy_points_espn)) %>%
ungroup()
rbs_by_season <-
rbs_by_week %>%
group_by(
season_type,
season,
player_id,
player_name,
position,
team) %>%
summarise(
games = sum(n()),
fantasy_points_dk = sum(fantasy_points_dk, na.rm = TRUE),
fantasy_points_espn = sum(fantasy_points_espn, na.rm = TRUE),
rushing_share = mean(rushing_share, na.rm = TRUE),
rushing_attempts = sum(rushing_attempts, na.rm = TRUE),
rushing_yards = sum(rushing_yards, na.rm = TRUE),
rushing_yards100 = sum(rushing_yards100, na.rm = TRUE),
rushing_tds = sum(rushing_tds, na.rm = TRUE),
rushing_fumbles = sum(rushing_fumbles, na.rm = TRUE),
rushing_fumbles_lost = sum(rushing_fumbles_lost, na.rm = TRUE),
rushing_first_downs = sum(rushing_first_downs, na.rm = TRUE),
rushing_epa = sum(rushing_epa, na.rm = TRUE),
rushing_2pt_conversions = sum(rushing_2pt_conversions, na.rm = TRUE),
receiving_target_share = mean(receiving_target_share, na.rm = TRUE),
receiving_air_yards_share = mean(receiving_air_yards_share, na.rm = TRUE),
receiving_receptions = sum(receiving_receptions, na.rm = TRUE),
receiving_target = sum(receiving_target, na.rm = TRUE),
receiving_yards = sum(receiving_yards, na.rm = TRUE),
receiving_yards100 = sum(receiving_yards100, na.rm = TRUE),
receiving_tds = sum(receiving_tds, na.rm = TRUE),
receiving_fumbles = sum(receiving_fumbles, na.rm = TRUE),
receiving_fumbles_lost = sum(receiving_fumbles_lost, na.rm = TRUE),
receiving_air_yards = sum(receiving_air_yards, na.rm = TRUE),
receiving_yards_after_catch = sum(receiving_yards_after_catch, na.rm = TRUE),
receiving_first_downs = sum(receiving_first_downs, na.rm = TRUE),
receiving_2pt_conversions = sum(receiving_2pt_conversions, na.rm = TRUE)) %>%
ungroup() %>%
group_by(
season_type,
season,
position) %>%
mutate(
fantasy_points_dk_rank = min_rank(-fantasy_points_dk),
fantasy_points_espn_rank = min_rank(-fantasy_points_espn)) %>%
ungroup()
wrs_by_season <-
wrs_by_week %>%
group_by(
season_type,
season,
player_id,
player_name,
position,
team) %>%
summarise(
games = sum(n()),
fantasy_points_dk = sum(fantasy_points_dk, na.rm = TRUE),
fantasy_points_espn = sum(fantasy_points_espn, na.rm = TRUE),
receiving_target_share = mean(receiving_target_share, na.rm = TRUE),
receiving_air_yards_share = mean(receiving_air_yards_share, na.rm = TRUE),
receiving_receptions = sum(receiving_receptions, na.rm = TRUE),
receiving_target = sum(receiving_target, na.rm = TRUE),
receiving_yards = sum(receiving_yards, na.rm = TRUE),
receiving_yards100 = sum(receiving_yards100, na.rm = TRUE),
receiving_tds = sum(receiving_tds, na.rm = TRUE),
receiving_fumbles = sum(receiving_fumbles, na.rm = TRUE),
receiving_fumbles_lost = sum(receiving_fumbles_lost, na.rm = TRUE),
receiving_air_yards = sum(receiving_air_yards, na.rm = TRUE),
receiving_yards_after_catch = sum(receiving_yards_after_catch, na.rm = TRUE),
receiving_first_downs = sum(receiving_first_downs, na.rm = TRUE),
receiving_2pt_conversions = sum(receiving_2pt_conversions, na.rm = TRUE),
rushing_share = mean(rushing_share, na.rm = TRUE),
rushing_attempts = sum(rushing_attempts, na.rm = TRUE),
rushing_yards = sum(rushing_yards, na.rm = TRUE),
rushing_yards100 = sum(rushing_yards100, na.rm = TRUE),
rushing_tds = sum(rushing_tds, na.rm = TRUE),
rushing_fumbles = sum(rushing_fumbles, na.rm = TRUE),
rushing_fumbles_lost = sum(rushing_fumbles_lost, na.rm = TRUE),
rushing_first_downs = sum(rushing_first_downs, na.rm = TRUE),
rushing_epa = sum(rushing_epa, na.rm = TRUE),
rushing_2pt_conversions = sum(rushing_2pt_conversions, na.rm = TRUE)) %>%
ungroup() %>%
group_by(
season_type,
season,
position) %>%
mutate(
fantasy_points_dk_rank = min_rank(-fantasy_points_dk),
fantasy_points_espn_rank = min_rank(-fantasy_points_espn)) %>%
ungroup()
tes_by_season <-
tes_by_week %>%
group_by(
season_type,
season,
player_id,
player_name,
position,
team) %>%
summarise(
games = sum(n()),
fantasy_points_dk = sum(fantasy_points_dk, na.rm = TRUE),
fantasy_points_espn = sum(fantasy_points_espn, na.rm = TRUE),
receiving_target_share = mean(receiving_target_share, na.rm = TRUE),
receiving_air_yards_share = mean(receiving_air_yards_share, na.rm = TRUE),
receiving_receptions = sum(receiving_receptions, na.rm = TRUE),
receiving_target = sum(receiving_target, na.rm = TRUE),
receiving_yards = sum(receiving_yards, na.rm = TRUE),
receiving_yards100 = sum(receiving_yards100, na.rm = TRUE),
receiving_tds = sum(receiving_tds, na.rm = TRUE),
receiving_fumbles = sum(receiving_fumbles, na.rm = TRUE),
receiving_fumbles_lost = sum(receiving_fumbles_lost, na.rm = TRUE),
receiving_air_yards = sum(receiving_air_yards, na.rm = TRUE),
receiving_yards_after_catch = sum(receiving_yards_after_catch, na.rm = TRUE),
receiving_first_downs = sum(receiving_first_downs, na.rm = TRUE),
receiving_2pt_conversions = sum(receiving_2pt_conversions, na.rm = TRUE),
rushing_share = mean(rushing_share, na.rm = TRUE),
rushing_attempts = sum(rushing_attempts, na.rm = TRUE),
rushing_yards = sum(rushing_yards, na.rm = TRUE),
rushing_yards100 = sum(rushing_yards100, na.rm = TRUE),
rushing_tds = sum(rushing_tds, na.rm = TRUE),
rushing_fumbles = sum(rushing_fumbles, na.rm = TRUE),
rushing_fumbles_lost = sum(rushing_fumbles_lost, na.rm = TRUE),
rushing_first_downs = sum(rushing_first_downs, na.rm = TRUE),
rushing_epa = sum(rushing_epa, na.rm = TRUE),
rushing_2pt_conversions = sum(rushing_2pt_conversions, na.rm = TRUE)) %>%
ungroup() %>%
group_by(
season_type,
season,
position) %>%
mutate(
fantasy_points_dk_rank = min_rank(-fantasy_points_dk),
fantasy_points_espn_rank = min_rank(-fantasy_points_espn)) %>%
ungroup()
write_parquet(qbs_by_season, 'posts/000_a_data_science_journey/results/qbs_by_season.parquet')
write_parquet(rbs_by_season, 'posts/000_a_data_science_journey/results/rbs_by_season.parquet')
write_parquet(wrs_by_season, 'posts/000_a_data_science_journey/results/wrs_by_season.parquet')
write_parquet(tes_by_season, 'posts/000_a_data_science_journey/results/tes_by_season.parquet')
rm(list = ls())
# # Finding players with multiple names
#
# players_multiple_names <-
#   player_stats %>%
#   distinct(player_id, player_name) %>%
#   group_by(player_id) %>%
#   count(player_id) %>%
#   filter(n > 1)
#
# multiple_names <-
#   wrs_by_season %>%
#   select(player_id, player_name, fantasy_points_espn) %>%
#   inner_join(players_multiple_names) %>%
#   arrange(-fantasy_points_espn)
library(tidyverse)
library(arrow)
rm(list = ls())
normalize <-
function(x, na.rm = TRUE) {
round((x- min(x)) /(max(x)-min(x)), 5)
}
qbs_by_week <- read_parquet('posts/000_a_data_science_journey/results/qbs_by_week.parquet')
rbs_by_week <- read_parquet('posts/000_a_data_science_journey/results/rbs_by_week.parquet')
wrs_by_week <- read_parquet('posts/000_a_data_science_journey/results/wrs_by_week.parquet')
tes_by_week <- read_parquet('posts/000_a_data_science_journey/results/tes_by_week.parquet')
colnames(qbs_by_week)
# Replacement level
